<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Facebook Post Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-72 bg-gray-800 p-6 flex flex-col gap-6 border-r border-gray-700">
      <div>
        <h2 class="text-lg font-bold mb-2">Facebook Credentials</h2>
        <label class="block text-gray-300 text-sm mb-1" for="fbAccessToken">Access Token</label>
        <input id="fbAccessToken" type="text" placeholder="Enter Facebook Access Token" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600 text-gray-100 mb-2">
        <label class="block text-gray-300 text-sm mb-1" for="fbPageId">Page ID</label>
        <input id="fbPageId" type="text" placeholder="Enter Facebook Page ID" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600 text-gray-100 mb-2">
        <button id="validateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-1 rounded mt-2">Validate & Save</button>
        <div id="tokenStatus" class="text-xs mt-2"></div>
      </div>
      <div>
        <h2 class="text-lg font-bold mb-2">Post Type</h2>
        <nav class="flex flex-col gap-2">
          <button type="button" data-type="text" class="post-type-btn bg-gray-700 hover:bg-blue-700 rounded px-3 py-1 text-left">Text Post</button>
          <button type="button" data-type="image" class="post-type-btn bg-gray-700 hover:bg-blue-700 rounded px-3 py-1 text-left">Image Post</button>
          <button type="button" data-type="link" class="post-type-btn bg-gray-700 hover:bg-blue-700 rounded px-3 py-1 text-left">Link Post</button>
          <button type="button" data-type="video" class="post-type-btn bg-gray-700 hover:bg-blue-700 rounded px-3 py-1 text-left">Video Post</button>
        </nav>
      </div>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 flex flex-col p-8 gap-8">
      <!-- Post Composer -->
      <section class="bg-gray-800 rounded-lg p-6 mb-4 shadow">
        <h2 class="text-xl font-bold mb-4">Post Composer</h2>
        <form id="composerForm" class="flex flex-col gap-4">
          <textarea id="composerMessage" rows="3" placeholder="Write your post..." class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 text-gray-100"></textarea>
          <div id="composerImageFields" class="hidden flex flex-col gap-2">
            <label class="text-gray-300">Choose Image(s)</label>
            <input id="composerImages" type="file" accept="image/*" multiple class="bg-gray-700 border border-gray-600 rounded text-gray-100">
          </div>
          <div id="composerLinkFields" class="hidden flex flex-col gap-2">
            <label class="text-gray-300">Link URL</label>
            <input id="composerLinkUrl" type="url" placeholder="https://example.com" class="bg-gray-700 border border-gray-600 rounded text-gray-100">
            <label class="text-gray-300">(Optional) Thumbnail Image</label>
            <input id="composerLinkImage" type="file" accept="image/*" class="bg-gray-700 border border-gray-600 rounded text-gray-100">
          </div>
          <div id="composerVideoFields" class="hidden flex flex-col gap-2">
            <label class="text-gray-300">Choose Video(s)</label>
            <input id="composerVideos" type="file" accept="video/*" multiple class="bg-gray-700 border border-gray-600 rounded text-gray-100">
          </div>
          <div class="flex gap-4 items-center">
            <input id="postNow" type="checkbox" class="mr-2">
            <label for="postNow" class="text-gray-300">Post Now</label>
            <span class="ml-6 text-gray-400">Schedule for:</span>
            <input id="scheduleTime" type="datetime-local" class="bg-gray-700 border border-gray-600 rounded text-gray-100 px-2 py-1">
            <select id="timezone" class="ml-2 bg-gray-700 border border-gray-600 rounded text-gray-100 px-2 py-1">
              <option value="Asia/Calcutta">Asia/Calcutta</option>
              <option value="UTC">UTC</option>
              <option value="America/New_York">America/New_York</option>
              <option value="Europe/London">Europe/London</option>
            </select>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Publish to Facebook</button>
            <button id="saveDraft" type="button" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Save Draft</button>
            <button id="restoreDraft" type="button" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Restore Draft</button>
            <button id="clearDraft" type="button" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Clear Draft</button>
            <button id="importCsv" type="button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Import CSV</button>
            <input id="gapMins" type="number" min="1" placeholder="Gap (mins)" class="bg-gray-700 border border-gray-600 rounded text-gray-100 px-2 py-1 w-24">
            <button id="aiGenerate" type="button" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">AI Generate</button>
          </div>
        </form>
      </section>
      <!-- Post Preview -->
      <section class="bg-gray-800 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-semibold mb-2">Post Preview</h3>
        <div id="postPreview" class="bg-gray-900 rounded p-3 min-h-[60px] text-gray-300"></div>
      </section>
      <!-- Post History & Logs -->
      <section class="bg-gray-800 rounded-lg p-4 flex-1">
        <h3 class="text-lg font-semibold mb-2">Post History & Logs</h3>
        <div id="postHistory" class="mb-4 max-h-60 overflow-y-auto"></div>
        <div id="logMessages" class="bg-blue-950 p-3 rounded text-gray-300 text-sm min-h-[40px]"></div>
      </section>
    </main>
  </div>
  <script>
    // --- UI State ---
    let currentPostType = 'text';
    let postHistory = [];
    // --- Sidebar Post Type Selection ---
    document.querySelectorAll('.post-type-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.post-type-btn').forEach(b => b.classList.remove('bg-blue-700'));
        this.classList.add('bg-blue-700');
        setPostType(this.dataset.type);
      });
    });
    function setPostType(type) {
      currentPostType = type;
      document.getElementById('composerImageFields').classList.toggle('hidden', type !== 'image');
      document.getElementById('composerLinkFields').classList.toggle('hidden', type !== 'link');
      document.getElementById('composerVideoFields').classList.toggle('hidden', type !== 'video');
      // Optionally reset preview
      updatePreview();
    }
    setPostType('text');
    // --- Composer Interactivity ---
    document.getElementById('composerForm').addEventListener('input', updatePreview);
    document.getElementById('composerForm').addEventListener('change', updatePreview);
    function updatePreview() {
      const msg = document.getElementById('composerMessage').value;
      let html = `<div class='mb-2'><b>Type:</b> ${currentPostType.charAt(0).toUpperCase()+currentPostType.slice(1)} Post</div>`;
      if (msg) html += `<div class='mb-2'><b>Message:</b> ${msg}</div>`;
      if (currentPostType === 'image') {
        const files = document.getElementById('composerImages').files;
        if (files.length) html += `<div><b>Images:</b> ${Array.from(files).map(f=>f.name).join(', ')}</div>`;
      }
      if (currentPostType === 'link') {
        const url = document.getElementById('composerLinkUrl').value;
        if (url) html += `<div><b>Link:</b> ${url}</div>`;
      }
      if (currentPostType === 'video') {
        const files = document.getElementById('composerVideos').files;
        if (files.length) html += `<div><b>Videos:</b> ${Array.from(files).map(f=>f.name).join(', ')}</div>`;
      }
      document.getElementById('postPreview').innerHTML = html;
    }
    // --- History & Logs ---
    function addHistoryEntry(entry) {
      postHistory.unshift(entry);
      renderHistory();
    }
    function renderHistory() {
      const container = document.getElementById('postHistory');
      container.innerHTML = postHistory.map(entry =>
        `<div class='bg-gray-700 rounded mb-2 p-2 flex flex-col gap-1'>
          <div class='text-xs text-gray-400'>${entry.time} | ${entry.type} | <span class='text-blue-400 cursor-pointer' onclick='navigator.clipboard.writeText("${entry.id}")'>Copy ID</span> | <span class='text-red-400 cursor-pointer' onclick='removeHistoryEntry("${entry.id}")'>Delete</span></div>
          <div>${entry.msg}</div>
        </div>`
      ).join('');
    }
    window.removeHistoryEntry = function(id) {
      postHistory = postHistory.filter(e => e.id !== id);
      renderHistory();
    }
    // --- Log ---
    function logMessage(msg) {
      const logDiv = document.getElementById('logMessages');
      logDiv.innerHTML += `<div>${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function clearLog() {
      document.getElementById('logMessages').innerHTML = '';
    }
    // --- Facebook Posting Logic (FULL IMPLEMENTATION) ---
    async function validateFacebookToken(token, pageId) {
      try {
        const url = `https://graph.facebook.com/v21.0/debug_token?input_token=${token}&access_token=${token}`;
        const res = await fetch(url);
        const data = await res.json();
        return res.ok && data.data && data.data.is_valid;
      } catch (e) { return false; }
    }

    async function createTextPost(message, scheduleTime, fbAccessToken, fbPageId) {
      const url = `https://graph.facebook.com/v21.0/${fbPageId}/feed`;
      const params = new URLSearchParams({
        message,
        access_token: fbAccessToken
      });
      if (scheduleTime) {
        params.append('published', 'false');
        params.append('scheduled_publish_time', Math.floor(new Date(scheduleTime).getTime()/1000));
      }
      const res = await fetch(url, { method: 'POST', body: params });
      const data = await res.json();
      if (res.ok && data.id) return data.id;
      throw new Error(data.error?.message || 'Unknown error');
    }

    async function uploadPhotoAndGetId(file, fbAccessToken, fbPageId) {
      const url = `https://graph.facebook.com/v21.0/${fbPageId}/photos`;
      const formData = new FormData();
      formData.append('source', file);
      formData.append('access_token', fbAccessToken);
      formData.append('published', 'false');
      const res = await fetch(url, { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok && data.id) return data.id;
      throw new Error(data.error?.message || 'Unknown error');
    }

    async function createImagePost(message, imageId, scheduleTime, fbAccessToken, fbPageId) {
      const url = `https://graph.facebook.com/v21.0/${fbPageId}/feed`;
      const params = new URLSearchParams();
      if (message) params.append('message', message);
      params.append('attached_media[0]', JSON.stringify({ media_fbid: imageId }));
      params.append('access_token', fbAccessToken);
      if (scheduleTime) {
        params.append('published', 'false');
        params.append('scheduled_publish_time', Math.floor(new Date(scheduleTime).getTime()/1000));
      }
      const res = await fetch(url, { method: 'POST', body: params });
      const data = await res.json();
      if (res.ok && data.id) return data.id;
      throw new Error(data.error?.message || 'Unknown error');
    }

    async function createLinkPost(message, linkUrl, scheduleTime, fbAccessToken, fbPageId) {
      const url = `https://graph.facebook.com/v21.0/${fbPageId}/feed`;
      const params = new URLSearchParams({
        link: linkUrl,
        message,
        access_token: fbAccessToken
      });
      if (scheduleTime) {
        params.append('published', 'false');
        params.append('scheduled_publish_time', Math.floor(new Date(scheduleTime).getTime()/1000));
      }
      const res = await fetch(url, { method: 'POST', body: params });
      const data = await res.json();
      if (res.ok && data.id) return data.id;
      throw new Error(data.error?.message || 'Unknown error');
    }

    async function uploadVideoAndGetId(file, fbAccessToken, fbPageId) {
      const url = `https://graph.facebook.com/v21.0/${fbPageId}/videos`;
      const formData = new FormData();
      formData.append('source', file);
      formData.append('access_token', fbAccessToken);
      formData.append('published', 'false');
      const res = await fetch(url, { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok && data.id) return data.id;
      throw new Error(data.error?.message || 'Unknown error');
    }

    async function createVideoPost(message, videoId, scheduleTime, fbAccessToken, fbPageId) {
      // Facebook auto-publishes video posts when uploaded, so just log
      return videoId;
    }

    document.getElementById('composerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      clearLog();
      const fbAccessToken = document.getElementById('fbAccessToken').value.trim();
      const fbPageId = document.getElementById('fbPageId').value.trim();
      const msg = document.getElementById('composerMessage').value.trim();
      const scheduleTime = document.getElementById('postNow').checked ? null : document.getElementById('scheduleTime').value;
      const postType = currentPostType;
      const gapMins = parseInt(document.getElementById('gapMins').value) || 0;
      try {
        if (!fbAccessToken || !fbPageId) throw new Error('Please enter Facebook credentials.');
        logMessage('Validating Facebook credentials...');
        if (!(await validateFacebookToken(fbAccessToken, fbPageId))) throw new Error('Invalid Facebook access token.');
        logMessage('Facebook access token is valid.');
        let postId;
        if (postType === 'text') {
          postId = await createTextPost(msg, scheduleTime, fbAccessToken, fbPageId);
        } else if (postType === 'image') {
          const files = document.getElementById('composerImages').files;
          if (!files.length) throw new Error('Please select at least one image.');
          if (files.length > 1 && (!gapMins || gapMins < 1)) throw new Error('Please specify a gap (in minutes) for multiple image posts.');
          let currentTime = scheduleTime ? new Date(scheduleTime) : new Date();
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            logMessage(`Uploading image: ${file.name} ...`);
            const imageId = await uploadPhotoAndGetId(file, fbAccessToken, fbPageId);
            const scheduledTime = i === 0 ? currentTime : new Date(currentTime.getTime() + i * gapMins * 60000);
            const postIdSingle = await createImagePost(msg, imageId, scheduledTime, fbAccessToken, fbPageId);
            addHistoryEntry({ id: postIdSingle, time: scheduledTime.toLocaleString(), type: postType, msg: msg + ' (' + file.name + ')' });
            logMessage(`<b>Success:</b> Posted image ${file.name} to Facebook. ID: ${postIdSingle}`);
          }
          postId = '(multiple image posts)';
        } else if (postType === 'link') {
          const linkUrl = document.getElementById('composerLinkUrl').value.trim();
          if (!linkUrl) throw new Error('Please enter a link URL.');
          postId = await createLinkPost(msg, linkUrl, scheduleTime, fbAccessToken, fbPageId);
        } else if (postType === 'video') {
          const files = document.getElementById('composerVideos').files;
          if (!files.length) throw new Error('Please select at least one video.');
          for (const file of files) {
            logMessage(`Uploading video: ${file.name} ...`);
            const videoId = await uploadVideoAndGetId(file, fbAccessToken, fbPageId);
            await createVideoPost(msg, videoId, scheduleTime, fbAccessToken, fbPageId);
          }
          postId = '(multiple video posts)';
        }
        if (postId && typeof postId === 'string' && !postId.startsWith('(')) {
          addHistoryEntry({ id: postId, time: new Date().toLocaleString(), type: postType, msg });
          logMessage(`<b>Success:</b> Posted ${postType} to Facebook. ID: ${postId}`);
        }
      } catch (err) {
        logMessage(`<span class='text-red-400'>${err.message || err}</span>`);
      }
    });
    // --- Validate Button ---
    document.getElementById('validateBtn').addEventListener('click', async function() {
      const token = document.getElementById('fbAccessToken').value.trim();
      const pageId = document.getElementById('fbPageId').value.trim();
      if (!token || !pageId) {
        document.getElementById('tokenStatus').innerHTML = '<span class="text-red-400">Please enter both token and page ID.</span>';
        return;
      }
      document.getElementById('tokenStatus').innerHTML = '<span class="text-yellow-400">Validating...</span>';
      const valid = await validateFacebookToken(token, pageId);
      if (valid) {
        document.getElementById('tokenStatus').innerHTML = '<span class="text-green-400">Token valid.</span>';
      } else {
        document.getElementById('tokenStatus').innerHTML = '<span class="text-red-400">Invalid token or page ID.</span>';
      }
    });
    // --- CSV Import for Text Posts ---
    document.getElementById('importCsv').addEventListener('click', function() {
      if (currentPostType !== 'text') {
        logMessage('<span class="text-yellow-400">CSV import is only available for text posts.</span>');
        return;
      }
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv,text/csv';
      fileInput.style.display = 'none';
      fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(event) {
          const text = event.target.result;
          const rows = text.split(/\r?\n/).filter(Boolean);
          let scheduledTime = document.getElementById('postNow').checked ? null : document.getElementById('scheduleTime').value;
          const fbAccessToken = document.getElementById('fbAccessToken').value.trim();
          const fbPageId = document.getElementById('fbPageId').value.trim();
          const gapMins = parseInt(document.getElementById('gapMins').value) || 0;
          if (!fbAccessToken || !fbPageId) {
            logMessage('<span class="text-red-400">Please enter Facebook credentials before importing CSV.</span>');
            return;
          }
          if (!(await validateFacebookToken(fbAccessToken, fbPageId))) {
            logMessage('<span class="text-red-400">Invalid Facebook access token.</span>');
            return;
          }
          let currentTime = scheduledTime ? new Date(scheduledTime) : new Date();
          for (let i = 0; i < rows.length; i++) {
            const message = rows[i];
            if (!message.trim()) continue;
            try {
              const postId = await createTextPost(message, currentTime, fbAccessToken, fbPageId);
              addHistoryEntry({ id: postId, time: currentTime.toLocaleString(), type: 'text', msg: message });
              logMessage(`<b>Success:</b> Posted text from CSV. ID: ${postId}`);
            } catch (err) {
              logMessage(`<span class='text-red-400'>Error posting row ${i+1}: ${err.message || err}</span>`);
            }
            if (gapMins && i < rows.length - 1) {
              currentTime = new Date(currentTime.getTime() + gapMins * 60000);
            }
          }
        };
        reader.readAsText(file);
      });
      document.body.appendChild(fileInput);
      fileInput.click();
      setTimeout(() => document.body.removeChild(fileInput), 1000);
    });
  </script>
</body>
</html>
